<!DOCTYPE html>
<html>
  <head>
    <title>E1 Calendar</title>
    <meta charset="utf-8" />

    <!-- Add js files -->
    <script src="login.js"></script>
    <script src="changeEvent.js"></script>
    <script type="module" src="fetchEvents.js"></script>

    <!-- Add Google API setup -->
    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="gapiLoaded()"
    ></script>
    <script
      async
      defer
      src="https://accounts.google.com/gsi/client"
      onload="gisLoaded()"
    ></script>

    <!-- Add Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <!-- Add Bootstrap JS and its dependencies -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- Add fullcalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>

    <!-- Calendar Script -->
    <script type="module">
      import { fetchEvents } from "./fetchEvents.js";

      var calendar;
      var eventsSource = [];
      var calendarInitialized = false;
      // Create the calendar
      async function initCalendar() {
        var calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          eventSources: eventsSource,
          datesSet: function (dateInfo) {
            onClick();
          },
          eventClick: function (info) {
            // when event is clicked
            // Fill in the modal with the event details
            $("#eventModalBody").html(`
          <p>Event: ${info.event.title}</p>
          <label>von: </label>
          <input type = "date"  id = "startdate">
          <input type = "time"  id = "starttime">
          <p></p>
          <label>bis: </label>
          <input type = "date"  id = "enddate">
          <input type = "time"  id = "endtime">
          `);

            displayChangeEvent(info.event);
            console.log("event: " + calendar.getEventById(info.event.id));
            // Show the modal
            $("#eventModal").modal();

            // change the border color just for fun
            info.el.style.borderColor = "red";
          },
          customButtons: {
            myCustomButton: {
              text: "custom!",
              click: function () {
                alert("clicked the custom button!");
              },
            },
          },
          headerToolbar: {
            left: "prev,next today myCustomButton",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek",
          },
          dateClick: function () {
            alert("a day has been clicked!");
          },
        });
        calendar.render();
        calendarInitialized = true;
      }

      // When the Google API is loaded and login is successful, load the calendar
      document.addEventListener("loginSuccess",()  => {
          initCalendar();
          if (calendarInitialized){ 
            document.addEventListener("renderEvents", onClick);  // Called when Google API Client is loaded AND if the user is signed in 
          }
        });
      document.addEventListener("changeEventSuccess", onClick); // update calendar after event is changed

      // Fetch the events for the calendar
      async function updateEvents() {
        var view = calendar.view;
        var startDate = view.activeStart;
        var endDate = view.activeEnd;
        eventsSource = await fetchEvents(startDate, endDate);
      }

      // Render the events on the calendar
      function renderEvents() {
        calendar.getEventSources().forEach(function (eventSource) {
          eventSource.remove();
        });
        calendar.addEventSource(eventsSource);
        calendar.refetchEvents();
      }

      async function onClick() { // when calendar is clicked
        await updateEvents();
        renderEvents();
      }

    </script>
  </head>

  <!-- ----------body---------- -->
  <body>
    <p>E1 Calendar</p>
    <!-- style="visibility: hidden;" -->
    <!--Buttons for Google Login Process-->
    <button
      id="authorize_button"
      style="visibility: hidden"
      onclick="handleAuthClick()"
    >
      Login
    </button>

    <div id="signed_in" style="visibility: hidden">
      <button id="signout_button" onclick="handleSignoutClick()">
        Sign Out
      </button>

      <!-- Displays calendar -->
      <div id="calendar"></div>

      <!-- changeEvent popup -->
      <div class="modal" tabindex="-1" role="dialog" id="eventModal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Event Details</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="eventModalBody">
              <!-- Event details will be added here -->
            </div>
            <div class="modal-footer">
              <!-- Add buttons here -->
              <button
                type="button"
                class="btn btn-primary"
                id="btnupdateEvent"
                onclick="changeEvent()"
                data-dismiss="modal"
              >
                update
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
