<!DOCTYPE html>
<html>

<head>
  <title>E1 Calendar</title>
  <meta charset="utf-8" />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js'></script>
  <script type="module"> // Use type="module" attribute
    import { fetchDates } from "./fetchDates.js";

    var calendar;
    var eventsSource = [];

    // Create the calendar
    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        eventSources: eventsSource,
        datesSet: function (dateInfo) {
          onClick();
        },
        eventClick: function (info) {
          alert('Event: ' + info.event.title);
          alert('Coordinates: ' + info.jsEvent.pageX + ',' + info.jsEvent.pageY);
          alert('View: ' + info.view.type);

          // change the border color just for fun
          info.el.style.borderColor = 'red';
        },
        customButtons: {
          myCustomButton: {
            text: 'custom!',
            click: function () {
              alert('clicked the custom button!');
            }
          }
        },
        headerToolbar: {
          left: 'prev,next today myCustomButton',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        dateClick: function() {
          alert('a day has been clicked!');
        }
      });
      calendar.render();
    }

    // Listen for the loginSuccess event
    document.addEventListener('loginSuccess', initCalendar);
    // Fetch the events for the calendar and render them
    export async function onClick() {
      await calendar.getEventSources().forEach(function (eventSource) {
        eventSource.remove();
      });
      //var date = calendar.getDate();
      var view = calendar.view;
      var startDate = view.activeStart;
      var endDate = view.activeEnd;
      eventsSource = await fetchDates(startDate, endDate);
      calendar.addEventSource(eventsSource);
      console.log(calendar.getEventSources());
      calendar.refetchEvents();
    }
  </script>
</head>

<body>
  <p>E1 Calendar</p>

  <!--Buttons for Google Login Process-->
  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <div id="signed_in">
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <!-- Displays events -->
    <pre id="content" style="white-space: pre-wrap;"></pre>
    <!-- Displays calendar -->
    <div id="calendar"></div>
  </div>
  <!-- <p><LINK></p> -->

  <!-- <script type="module" src="calFunc.js"></script> -->
  <script src="login.js"></script>
  <script type="module" src="fetchDates.js"></script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>

</html>