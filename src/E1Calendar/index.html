<!DOCTYPE html>
<html>

<head>
  <title>E1 Calendar</title>
  <meta charset="utf-8" />
  <!-- Add Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  <!-- Add Bootstrap JS and its dependencies -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js'></script>
  <script type="module"> // Use type="module" attribute
    import { fetchDates } from "./fetchDates.js";

    var calendar;
    var eventsSource = [];

    // Create the calendar
    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        eventSources: eventsSource,
        datesSet: function (dateInfo) {
          onClick();
        },
        eventClick: function (info) {
          // Fill in the modal with the event details
          $('#eventModalBody').html(`
          <p>Event: ${info.event.title}</p>
          <label>von: </label>
          <input type = "date"  id = "startdate">
          <input type = "time"  id = "starttime">
          <p></p>
          <label>bis: </label>
          <input type = "date"  id = "enddate">
          <input type = "time"  id = "endtime">
          
          <p>View: ${info.view.type}</p>
          `);
          
          displayEvent(info.event);
          console.log("event: "+calendar.getEventById( info.event.id ));
          // Show the modal
          $('#eventModal').modal();

          // change the border color just for fun
          info.el.style.borderColor = 'red';
        },
        customButtons: {
          myCustomButton: {
            text: 'custom!',
            click: function () {
              alert('clicked the custom button!');
            }
          }
        },
        headerToolbar: {
          left: 'prev,next today myCustomButton',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        dateClick: function () {
          alert('a day has been clicked!');
        }
      });
      calendar.render();
    }

    // let btn=document.getElementById("btnupdateEvent");
    // btn.addEventListener("click", updateEvent);

    // function updateEvent(){
    //   let id="50g61gmekgdg641c4pgalnjhj8";
    //   let eventId="50g61gmekgdg641c4pgalnjhj8";
    //   console.log("update Event");
    //   let startdate=document.getElementById("startdate").value;
    //   let enddate=document.getElementById("enddate").value;  
    //   let starttime=document.getElementById("starttime").value;
    //   let endtime=document.getElementById("endtime").value;  
    //   // console.log(startdate+enddate+starttime+endtime);
      
    //   // 2018-06-01T12:30:00-05:00
    //   // let start=startdate+"T"+starttime+"+02:00";
    //   // let end=enddate+"T"+endtime+"+02:00";
    //   // let pevent=calendar.getEventById(id);
    //   // console.log("start: "+start+"\nend: "+end);
    //   // pevent.setStart(start);
    //   // pevent.setEnd(end);
    //   // console.log(pevent);
    //   // calendar.addEvent( pevent );

    //   const startDateTime = new Date(startdate + "T" + starttime + ":00");
    //   const endDateTime = new Date(enddate + "T" + endtime + ":00");
    //   const event = {
    //     // summary: summary,
    //     start: {
    //       dateTime: startDateTime.toISOString(),
    //       timeZone: 'Europe/Berlin'
    //     },
    //     end: {
    //       dateTime: endDateTime.toISOString(),
    //       timeZone: 'Europe/Berlin'
    //     },
    //   };
    
    //   const request = gapi.client.calendar.events.patch({
    //     'calendarId': 'primary',
    //     'eventId': eventId,
    //     'resource': event
    //   });
    //   request.execute(function(event) {
    //     console.log('Event updated: ' + event.htmlLink);
    //   });
    // }


    // Listen for the loginSuccess event
    document.addEventListener('loginSuccess', initCalendar);
    // Fetch the events for the calendar and render them
    export async function onClick() {
      await calendar.getEventSources().forEach(function (eventSource) {
        eventSource.remove();
      });
      //var date = calendar.getDate();
      var view = calendar.view;
      var startDate = view.activeStart;
      var endDate = view.activeEnd;
      eventsSource = await fetchDates(startDate, endDate);
      calendar.addEventSource(eventsSource);
      console.log(calendar.getEventSources());
      calendar.refetchEvents();
    }
  </script>
</head>

<body>
  <p>E1 Calendar</p>

  <!--Buttons for Google Login Process-->
  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <div id="signed_in">
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <div class="modal" tabindex="-1" role="dialog" id="eventModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Event Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="eventModalBody">
            <!-- Event details will be added here -->
          </div>
          <div class="modal-footer">
            <!-- Add buttons here -->
            <button type="button" class="btn btn-primary" id="btnupdateEvent" onclick="updateEvent()" >update</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Displays events -->
    <pre id="content" style="white-space: pre-wrap;"></pre>
    <!-- Displays calendar -->
    <div id="calendar"></div>
  </div>
  <!-- <p><LINK></p> -->

  <!-- <script type="module" src="calFunc.js"></script> -->
  <script src="login.js"></script>
  <script src="updateEvent.js"></script>
  <script type="module" src="fetchDates.js"></script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>

</html>